const multer = require("multer");
const { gfs, initGridFS } = require("./gridfs"); 

initGridFS(); // initialize your custom GridFS instance

const storage = new multer.Storage({
  _handleFile: (req, file, cb) => {
    const writeStream = gfs.createWriteStream({
      filename: file.originalname,
      contentType: file.mimetype,
    });
    file.stream.pipe(writeStream);
    writeStream.on("finish", () => {
      cb(null, { filename: file.originalname, mimetype: file.mimetype });
    });
  },
  _removeFile: (req, file, cb) => {
    gfs.remove({ filename: file.filename }, (err) => {
      if (err) {
        cb(err);
      } else {
        cb(null);
      }
    });
  },
});

const upload = multer({ storage }).array("files", 200);
